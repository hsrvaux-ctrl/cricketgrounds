<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title id="meta-title">Cricket Ground — Details & Ratings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta id="meta-description" name="description" content="">
  <meta property="og:title" content="" id="og-title">
  <meta property="og:description" content="" id="og-desc">
  <meta property="og:image" content="" id="og-image">
  <meta property="og:type" content="article">
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">

  <link rel="stylesheet" href="assets/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
</head>
<body>
  <header>
    <div class="navbar container">
      <div class="brand"><a href="./index.html" class="btn">← Back</a><h1 id="title" style="margin:0 0 0 10px">Ground</h1></div>
      <div class="nav">
        <a class="btn" id="share-btn" href="#">Share</a>
        <a class="btn" id="copy-btn" href="#">Copy link</a>
      </div>
    </div>
  </header>

  <main class="container" style="grid-template-columns: 1fr 420px">
    <section class="card">
      <img id="hero" class="hero" alt="" src="">
      <div class="credit" id="credit"></div>
      <div class="muted" id="club"></div>
      <div class="muted" id="county"></div>
      <div class="muted" id="address"></div>
      <p id="desc"></p>
      <p><span class="rating" id="avg">★</span> <span id="count"></span></p>
      <p id="actions"></p>
      <p><a class="btn primary" id="rate-open" href="#">Rate this ground</a></p>
    </section>

    <aside class="side">
      <div class="card"><div id="map" style="height:340px"></div></div>
      <div class="card">
        <h3 style="margin-top:0">Facilities</h3>
        <dl>
          <dt>Pitch type</dt><dd id="pitch"></dd>
          <dt>Strips</dt><dd id="strips"></dd>
          <dt>Nets</dt><dd id="nets"></dd>
          <dt>Bar</dt><dd id="bar"></dd>
          <dt>Parking</dt><dd id="parking"></dd>
        </dl>
      </div>
    </aside>
  </main>

  <dialog id="rate-dialog">
    <form method="dialog" class="modal" id="rate-form">
      <h3>Rate this ground</h3>
      <div class="row"><label>Pitch quality</label><input type="range" min="1" max="5" value="3" name="pitch" aria-label="Pitch quality"></div>
      <div class="row"><label>Pavilion & facilities</label><input type="range" min="1" max="5" value="3" name="pavilion" aria-label="Pavilion and facilities"></div>
      <div class="row"><label>Bar/tea quality</label><input type="range" min="1" max="5" value="3" name="bar" aria-label="Bar and tea quality"></div>
      <div class="row"><label>Atmosphere & friendliness</label><input type="range" min="1" max="5" value="3" name="atmosphere" aria-label="Atmosphere and friendliness"></div>
      <div class="row"><label>Value for money</label><input type="range" min="1" max="5" value="3" name="value" aria-label="Value for money"></div>
      <div class="row"><label>Your name (optional)</label><input type="text" name="name" placeholder="e.g. Hugo"></div>
      <div class="row"><label>Comment (optional)</label><input type="text" name="comment" placeholder="What stood out?"></div>
      <div class="btns">
        <button class="btn" id="rate-cancel">Cancel</button>
        <button class="btn primary" id="rate-submit">Submit</button>
      </div>
      <p id="rate-status" class="muted" role="status"></p>
    </form>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  const $ = sel => document.querySelector(sel);
  function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 1800); }
  const params = new URLSearchParams(location.search); let id = params.get('id');
  if (id === 'random') { fetch('data/grounds.json').then(r=>r.json()).then(rows=>{ const g=rows[Math.floor(Math.random()*rows.length)]; location.replace('ground.html?id='+encodeURIComponent(g.id)); }); }

  let g=null, ratings=[];
  function avgText(a){ return isFinite(a) ? '★ '+(Math.round(a*10)/10).toFixed(1) : 'No ratings yet'; }
  function computeAgg(list){ const forThis=list.filter(r=>r.ground_id===g.id); const n=forThis.length; if(!n) return {avg:null,count:0}; let sum=0; forThis.forEach(r=>{ sum += (r.pitch+r.pavilion+r.bar+r.atmosphere+r.value)/5; }); return {avg:sum/n,count:n}; }
  function truthy(v){ return v?'Yes':'No'; }
  function setSEO(){
    $('#meta-title').textContent = g.name+' — Ratings & Info';
    $('#meta-description').setAttribute('content','Learn about '+g.name+' in '+(g.county||'')+'. See ratings, facilities and more.');
    $('#og-title').setAttribute('content', g.name+' — Ratings & Info');
    $('#og-desc').setAttribute('content','Explore '+g.name+' with ratings and facilities.');
    if(g.image_url) $('#og-image').setAttribute('content', g.image_url);
  }
  function initMap(lat,lon,name){ const map=L.map('map').setView([lat,lon],14); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap contributors'}).addTo(map); L.marker([lat,lon]).addTo(map).bindPopup(name).openPopup(); }
  async function loadAll(){
    const [grounds, ratingList] = await Promise.all([ fetch('data/grounds.json',{cache:'no-cache'}).then(r=>r.json()), fetch('data/ratings.json',{cache:'no-cache'}).then(r=>r.json()) ]);
    g = grounds.find(r=>r.id===id) || grounds[0]; ratings = ratingList;
    $('#title').textContent = g.name;
    const hero=$('#hero'); if(g.image_url){ hero.src=g.image_url; hero.alt=g.name; } else { hero.style.display='none'; }
    $('#club').textContent=g.club||''; $('#county').textContent=g.county||''; $('#address').textContent=g.address||''; $('#desc').textContent=g.description||'';
    const credit=[g.image_credit,g.image_license].filter(Boolean).join(' • '); $('.credit').textContent=credit;
    $('#pitch').textContent=g.pitch_type||'Unknown'; $('#strips').textContent = (g.strips ?? 'Unknown'); $('#nets').textContent=truthy(g.nets); $('#bar').textContent=truthy(g.bar); $('#parking').textContent=truthy(g.parking);
    const btns=[]; if(g.club_url) btns.push('<a class="btn" target="_blank" rel="noopener" href="'+g.club_url+'">Club site</a>');
    if(g.play_cricket_url) btns.push('<a class="btn" target="_blank" rel="noopener" href="'+g.play_cricket_url+'">Play Cricket</a>');
    if(g.booking_url) btns.push('<a class="btn" target="_blank" rel="noopener" href="'+g.booking_url+'">Book this ground</a>');
    $('#actions').innerHTML = btns.join(' ');
    const agg=computeAgg(ratings); $('#avg').textContent=avgText(agg.avg); $('#count').textContent = agg.count? '('+agg.count+' ratings)' : '';
    setSEO(); initMap(+g.lat,+g.lon,g.name); initShare(); initRating();
  }
  function initShare(){
    $('#share-btn').addEventListener('click', async e=>{
      e.preventDefault(); const url=location.href, title=document.title, text='Check out this cricket ground';
      if(navigator.share){ try{ await navigator.share({title,text,url}); }catch{} }
      else{ window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(text)+'&url='+encodeURIComponent(url),'_blank'); }
    });
    $('#copy-btn').addEventListener('click', async e=>{ e.preventDefault(); try{ await navigator.clipboard.writeText(location.href); toast('Link copied'); }catch{} });
  }
  function initRating(){
    const dlg=$('#rate-dialog');
    $('#rate-open').addEventListener('click', e=>{ e.preventDefault(); dlg.showModal(); });
    $('#rate-cancel').addEventListener('click', e=>{ e.preventDefault(); dlg.close(); });
    $('#rate-submit').addEventListener('click', async e=>{
      e.preventDefault();
      const f=$('#rate-form');
      const payload = { ground_id: g.id, pitch:+f.pitch.value, pavilion:+f.pavilion.value, bar:+f.bar.value, atmosphere:+f.atmosphere.value, value:+f.value.value, name:f.name.value||'', comment:f.comment.value||'' };
      const status=$('#rate-status'); status.textContent='Submitting…';
      try{
        const res=await fetch('/.netlify/functions/submit_rating',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
        if(!res.ok) throw new Error('HTTP '+res.status);
        status.textContent='Thanks — rating received!'; setTimeout(()=>dlg.close(),800);
      }catch(err){ status.textContent='Submission failed'; }
    });
  }
  loadAll();
  </script>
</body>
</html>

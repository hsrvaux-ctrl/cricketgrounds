<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>UK Cricket Grounds — Map, Ratings & Info</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Explore every cricket ground in the UK. Find nearby grounds, see ratings, facilities, and history.">
  <meta property="og:title" content="UK Cricket Grounds — Map, Ratings & Info">
  <meta property="og:description" content="Explore cricket grounds near you. See ratings, facilities and history.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="assets/logo.svg">
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">

  <link rel="stylesheet" href="assets/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
</head>
<body>
  <header>
    <div class="navbar container">
      <div class="brand">
        <img src="assets/logo.svg" alt="Logo"><h1>UK Cricket Grounds</h1>
      </div>
      <nav class="nav">
        <a class="btn" href="#" id="btn-nearby" aria-label="Find grounds near me">Nearby me</a>
        <a class="btn" href="#" id="btn-today" aria-label="Pick ground of the day">Ground of the Day</a>
        <a class="btn primary" href="ground.html?id=random" aria-label="Open a random ground">Random ground</a>
      </nav>
    </div>
  </header>

  <section class="feature container" id="god" aria-live="polite">
    <img id="god-img" alt="">
    <div>
      <h2 id="god-title">Ground of the Day</h2>
      <div class="muted" id="god-meta"></div>
      <div class="muted" id="god-desc"></div>
    </div>
    <a class="btn primary" id="god-link" href="#">View</a>
  </section>

  <section class="controls">
    <div class="wrap container">
      <input id="q" type="search" placeholder="Search by ground or club" aria-label="Search">
      <select id="county" aria-label="Filter by county"><option value="">All counties</option></select>
      <select id="facility" aria-label="Filter by facility">
        <option value="">Any facility</option>
        <option value="nets">Has nets</option>
        <option value="bar">Has bar</option>
        <option value="parking">Has parking</option>
      </select>
      <select id="sort" aria-label="Sort results">
        <option value="name">Sort A–Z</option>
        <option value="rating">Highest rated</option>
        <option value="popular">Most rated</option>
      </select>
    </div>
  </section>

  <main class="container">
    <div class="map-wrap" role="region" aria-label="Map of cricket grounds">
      <div id="map"></div>
    </div>
    <aside class="side">
      <div class="card"><div id="result-count" class="muted">Loading grounds…</div></div>
      <div class="card" id="list"></div>
    </aside>
  </main>

  <footer class="container">
    <div>Map data © OpenStreetMap contributors • Built with Leaflet</div>
    <div class="muted">Made for cricket lovers • <a href="https://github.com/" rel="noopener" target="_blank">Contribute</a></div>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
  let map, cluster, markers = [], data = [], filtered = [], ratings = [], aggByGround = new Map();
  const $ = sel => document.querySelector(sel);
  function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 1800); }
  function starHtml(avg){ if(avg==null) return ''; const s=Math.round(avg*10)/10; return '★ '+s.toFixed(1); }
  function computeAggregates(){
    aggByGround = new Map();
    ratings.forEach(r=>{
      const id=r.ground_id;
      const score=(r.pitch+r.pavilion+r.bar+r.atmosphere+r.value)/5;
      const o=aggByGround.get(id)||{count:0,sum:0};
      o.count++; o.sum+=score; aggByGround.set(id,o);
    });
  }
  function getAgg(id){ const x=aggByGround.get(id); return x?{avg:x.sum/x.count,count:x.count}:{avg:null,count:0}; }
  function initMap(){
    map=L.map('map',{ zoomControl:true, scrollWheelZoom:true }).setView([52.8,-1.6],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
    cluster=L.markerClusterGroup({ showCoverageOnHover:false, spiderfyOnMaxZoom:true }); map.addLayer(cluster);
  }
  function markerFor(g){
    const ag=getAgg(g.id);
    const html = `
      <div style="display:flex;gap:10px;align-items:flex-start;">
        ${g.image_url ? '<img src="'+g.image_url+'" alt="" style="width:88px;height:64px;object-fit:cover;border-radius:10px;border:1px solid var(--line)">' : ''}
        <div>
          <strong>${g.name}</strong> ${ag.count?'<span style="color:#ffb44d">'+starHtml(ag.avg)+'</span>':''}<br>
          ${g.club ? g.club+'<br>':''}
          ${g.county ? '<small class="muted">'+g.county+'</small><br>':''}
          <a class="btn" style="padding:6px 10px;border-radius:10px" href="ground.html?id=${encodeURIComponent(g.id)}">View</a>
        </div>
      </div>`;
    const m=L.marker([g.lat,g.lon]); m.bindPopup(html); m._groundId=g.id; return m;
  }
  function renderMarkers(){ cluster.clearLayers(); markers=[]; filtered.forEach(g=>{ if(Number.isFinite(g.lat)&&Number.isFinite(g.lon)){ const m=markerFor(g); markers.push(m); cluster.addLayer(m);} }); }
  function renderList(){
    const list=$('#list'); list.innerHTML='';
    filtered.forEach(g=>{
      const ag=getAgg(g.id);
      const item=document.createElement('a'); item.href='ground.html?id='+encodeURIComponent(g.id);
      item.className='item'; item.setAttribute('aria-label','Open '+g.name);
      item.innerHTML = (g.image_url?'<img src="'+g.image_url+'" alt="">':'<div style="width:72px;height:52px;border:1px solid var(--line);border-radius:10px"></div>')+
        '<div><h4>'+g.name+'</h4><small>'+(g.club||'')+(g.club&&g.county?' · ':'')+(g.county||'')+'</small> '+(ag.count?'<small>· '+starHtml(ag.avg)+' ('+ag.count+')</small>':'')+'</div>';
      list.appendChild(item);
    });
    $('#result-count').textContent = filtered.length+' grounds';
  }
  function applyFilters(){
    const q=$('#q').value.toLowerCase().trim();
    const county=$('#county').value;
    const facility=$('#facility').value;
    const sort=$('#sort').value;
    filtered=data.filter(g=>{
      const text=(g.name+' '+(g.club||'')+' '+(g.county||'')).toLowerCase();
      const matchQ = !q || text.includes(q);
      const matchCounty = !county || g.county===county;
      let matchFac=true;
      if(facility==='nets') matchFac=!!g.nets;
      if(facility==='bar') matchFac=!!g.bar;
      if(facility==='parking') matchFac=!!g.parking;
      return matchQ && matchCounty && matchFac;
    });
    if(sort==='name') filtered.sort((a,b)=>a.name.localeCompare(b.name));
    if(sort==='rating') filtered.sort((a,b)=> (getAgg(b.id).avg||0)-(getAgg(a.id).avg||0) );
    if(sort==='popular') filtered.sort((a,b)=> (getAgg(b.id).count||0)-(getAgg(a.id).count||0) );
    renderMarkers(); renderList();
  }
  function populateCountyFilter(){ const select=$('#county'); const set=new Set(data.map(g=>g.county).filter(Boolean)); [...set].sort().forEach(c => { const opt=document.createElement('option'); opt.value=c; opt.textContent=c; select.appendChild(opt); }); }
  function godPick(){
    const elig=data.filter(g=>g.image_url && g.description);
    const g = elig[Math.floor(Math.random()*Math.max(elig.length,1))] || data[0];
    $('#god-img').src=g.image_url||''; $('#god-img').alt=g.name;
    $('#god-title').textContent=g.name; $('#god-meta').textContent=[g.club,g.county].filter(Boolean).join(' · ');
    $('#god-desc').textContent=g.description||''; $('#god-link').href='ground.html?id='+encodeURIComponent(g.id);
  }
  function nearbyMe(){ if(!navigator.geolocation) return toast('Geolocation not supported'); navigator.geolocation.getCurrentPosition(p=>{ map.setView([p.coords.latitude,p.coords.longitude], 11); toast('Centered near you'); }, _=> toast('Could not get your location'), {enableHighAccuracy:true, timeout:8000}); }
  async function loadData(){
    const [groundsRes, ratingsRes] = await Promise.all([ fetch('data/grounds.json',{cache:'no-cache'}), fetch('data/ratings.json',{cache:'no-cache'}) ]);
    data=(await groundsRes.json()).map(r=>({...r, lat:+r.lat, lon:+r.lon})); ratings=await ratingsRes.json();
    computeAggregates(); populateCountyFilter(); applyFilters(); godPick();
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    initMap(); loadData();
    $('#q').addEventListener('input', applyFilters);
    $('#county').addEventListener('change', applyFilters);
    $('#facility').addEventListener('change', applyFilters);
    $('#sort').addEventListener('change', applyFilters);
    $('#btn-nearby').addEventListener('click', e=>{e.preventDefault(); nearbyMe();});
    $('#btn-today').addEventListener('click', e=>{e.preventDefault(); godPick(); toast('New ground of the day');});
  });
  </script>
</body>
</html>
